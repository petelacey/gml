version: '1.0'
steps:
  build_test_image:
    title: Building Test Image
    type: build
    description: Building an image to run tests
    dockerfile: Dockerfile.test
    image-name: petelacey/gml_test
    tag: latest

  run_tests:
    title: Running Tests
    type: composition
    composition:
      version: '2'
      services:
        postgres:
          image: postgres:9.6
          ports:
            - "5432"
          environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres

    composition_candidates:
      test:
        image: petelacey/gml_test:latest
        links:
          - postgres
        command: bash -c '/app/scripts/codefresh-unit-tests.sh'

  build_production_image:
    title: Building Production Image
    type: build
    description: Building an image to deploy to prod
    dockerfile: Dockerfile
    image-name: petelacey/gml
    tag: latest

  deploy-elastic-beanstalk:
    fail-fast: false
    image: garland/aws-cli-docker:latest
    commands:
     - sh -c  "aws configure set region '${{AWS_REGION}}' && aws elasticbeanstalk update-environment --environment-name '${{AWS_ENV_NAME}}' --version-label '${{AWS_VERSION}}' "
    when:
      condition:
        all:
          masterBranch: "'${{CF_BRANCH}}' == '${{AWS_BRANCH}}'"
